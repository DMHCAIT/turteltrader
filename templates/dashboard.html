<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #0e1117;
            color: #fafafa;
        }
        .navbar-dark {
            background-color: #262730 !important;
        }
        .card {
            background-color: #262730;
            border: 1px solid #3f3f46;
        }
        .card-header {
            background-color: #374151;
            border-bottom: 1px solid #3f3f46;
        }
        .btn-primary {
            background-color: #00D4AA;
            border-color: #00D4AA;
        }
        .btn-primary:hover {
            background-color: #00B89A;
            border-color: #00B89A;
        }
        .status-connected {
            color: #00D4AA;
        }
        .status-disconnected {
            color: #ef4444;
        }
        .metric-card {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00D4AA;
        }
        .metric-label {
            color: #9ca3af;
            font-size: 0.9rem;
        }
        .table-dark {
            background-color: #262730;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>ETF Trading Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="/config">
                    <i class="fas fa-cog me-1"></i>Configuration
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Bar -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div id="api-status">
                                    <i class="fas fa-circle status-disconnected me-2"></i>
                                    <span>Checking API...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="balance-status">
                                    <i class="fas fa-wallet me-2"></i>
                                    <span>Balance: Loading...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="etf-status">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    <span>ETFs: Loading...</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div id="time-status">
                                    <i class="fas fa-clock me-2"></i>
                                    <span id="current-time"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Metrics -->
        <div class="row mb-4" id="balance-section" style="display: none;">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="available-cash">₹0</div>
                    <div class="metric-label">Available Cash</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="total-balance">₹0</div>
                    <div class="metric-label">Total Balance</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="used-margin">₹0</div>
                    <div class="metric-label">Used Margin</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="margin-utilization">0%</div>
                    <div class="metric-label">Margin Used</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Chart Section -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>Portfolio Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="portfolio-chart"></div>
                    </div>
                </div>
            </div>

            <!-- Trade Panel -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Quick Trade
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="trade-form">
                            <div class="mb-3">
                                <label for="symbol" class="form-label">ETF Symbol</label>
                                <select class="form-select" id="symbol" required>
                                    <option value="">Select ETF...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="action" class="form-label">Action</label>
                                <select class="form-select" id="action" required>
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" min="1" max="1000" value="10" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-rocket me-2"></i>Execute Trade
                            </button>
                        </form>

                        <hr>

                        <h6>Recent Trades</h6>
                        <div id="recent-trades">
                            <small class="text-muted">No recent trades</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ETF Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>ETF Monitoring
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped" id="etf-table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Volume</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="etf-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading ETF data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Check API status
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                
                const apiStatusElement = document.getElementById('api-status');
                if (statusData.connected) {
                    apiStatusElement.innerHTML = '<i class="fas fa-circle status-connected me-2"></i>Connected: ' + statusData.user;
                    document.getElementById('balance-section').style.display = 'block';
                    loadBalanceData();
                } else {
                    apiStatusElement.innerHTML = '<i class="fas fa-circle status-disconnected me-2"></i>' + statusData.message;
                }

                // Load ETF data
                const etfResponse = await fetch('/api/etfs');
                const etfData = await etfResponse.json();
                
                if (etfData.success) {
                    displayETFData(etfData.data);
                    populateETFDropdown(etfData.data);
                    document.getElementById('etf-status').innerHTML = 
                        '<i class="fas fa-chart-bar me-2"></i>ETFs: ' + etfData.data.length;
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadBalanceData() {
            try {
                const response = await fetch('/api/balance');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('available-cash').textContent = '₹' + data.data.available_cash.toLocaleString();
                    document.getElementById('total-balance').textContent = '₹' + data.data.total_balance.toLocaleString();
                    document.getElementById('used-margin').textContent = '₹' + data.data.used_margin.toLocaleString();
                    document.getElementById('margin-utilization').textContent = (data.data.margin_utilization * 100).toFixed(1) + '%';
                    document.getElementById('balance-status').innerHTML = 
                        '<i class="fas fa-wallet me-2"></i>Balance: ₹' + data.data.available_cash.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading balance data:', error);
            }
        }

        function displayETFData(etfs) {
            const tableBody = document.getElementById('etf-table-body');
            tableBody.innerHTML = '';
            
            etfs.forEach(etf => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${etf.symbol}</strong></td>
                    <td>${etf.name}</td>
                    <td><span class="badge bg-secondary">${etf.category}</span></td>
                    <td>${etf.volume.toLocaleString()}</td>
                    <td><span class="badge bg-success">${etf.status}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function populateETFDropdown(etfs) {
            const select = document.getElementById('symbol');
            select.innerHTML = '<option value="">Select ETF...</option>';
            
            etfs.forEach(etf => {
                const option = document.createElement('option');
                option.value = etf.symbol;
                option.textContent = etf.symbol + ' - ' + etf.name;
                select.appendChild(option);
            });
        }

        // Load chart data
        async function loadChart() {
            try {
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                
                if (data.chart) {
                    const chartData = JSON.parse(data.chart);
                    Plotly.newPlot('portfolio-chart', chartData.data, chartData.layout, {responsive: true});
                }
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        // Handle trade form submission
        document.getElementById('trade-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('symbol').value;
            const action = document.getElementById('action').value;
            const quantity = document.getElementById('quantity').value;
            
            // Simulate trade execution
            const tradeDiv = document.createElement('div');
            tradeDiv.className = 'alert alert-info alert-sm mt-2';
            tradeDiv.innerHTML = `
                <small>
                    <strong>${new Date().toLocaleTimeString()}</strong><br>
                    ${action} ${quantity} ${symbol}<br>
                    Status: Simulated
                </small>
            `;
            
            const recentTrades = document.getElementById('recent-trades');
            recentTrades.insertBefore(tradeDiv, recentTrades.firstChild);
            
            // Keep only last 3 trades
            while (recentTrades.children.length > 3) {
                recentTrades.removeChild(recentTrades.lastChild);
            }
            
            // Reset form
            this.reset();
            document.getElementById('symbol').value = '';
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadChart();
            
            // Refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>